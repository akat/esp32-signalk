[platformio]
default_envs = esp32dev

[env:esp32dev]
platform = espressif32
board = esp32dev
framework = arduino

; Serial Monitor
monitor_speed = 115200
monitor_filters = 
    esp32_exception_decoder
    time
    colorize

; Upload settings
upload_speed = 921600

; Build flags
build_flags =
    -DCORE_DEBUG_LEVEL=3
    -DBOARD_HAS_PSRAM
    -mfix-esp32-psram-cache-issue
    -D CONFIG_ASYNC_TCP_RUNNING_CORE=1
    -D CONFIG_ASYNC_TCP_USE_WDT=0
    ; NMEA2000 CAN pins for TTGO T-CAN485 (correct hardware pins)
    -D ESP32_CAN_TX_PIN=GPIO_NUM_27
    -D ESP32_CAN_RX_PIN=GPIO_NUM_26

; Exclude the original monolithic main file
build_src_filter = +<*> -<main_original.cpp>

; Dependencies
lib_deps =
    ; WiFiManager for easy configuration
    tzapu/WiFiManager@^2.0.16-rc.2

    ; Async Web Server
    https://github.com/me-no-dev/ESPAsyncWebServer.git
    esp32async/AsyncTCP@^3.4.9

    ; JSON parsing
    bblanchon/ArduinoJson@^6.21.3

    ; NMEA2000 library for CAN bus
    https://github.com/ttlappalainen/NMEA2000.git
    https://github.com/ttlappalainen/NMEA2000_esp32.git

    ; I2C sensors
    adafruit/Adafruit BME280 Library@^2.2.2
    adafruit/Adafruit Unified Sensor@^1.1.14
    adafruit/Adafruit BusIO@^1.14.5

    ; WS2812 RGB LED support
    adafruit/Adafruit NeoPixel@^1.12.0

    ; SoftwareSerial for Seatalk1 (no hardware serial conflict)
    plerup/EspSoftwareSerial@^8.2.0

    ; mDNS is included in ESP32 core

; Partitions for larger app - use huge_app for NMEA2000 support
board_build.partitions = huge_app.csv

; Flash settings
board_build.flash_mode = dio
board_build.f_flash = 80000000L
board_build.f_cpu = 240000000L

; OTA Updates (optional)
; upload_protocol = espota
; upload_port = signalk.local


; ===============================================
; Alternative boards configurations
; ===============================================

[env:esp32-wrover]
platform = espressif32
board = esp32-wrover-kit
framework = arduino
monitor_speed = 115200
upload_speed = 921600

build_flags = 
    -DCORE_DEBUG_LEVEL=3
    -DBOARD_HAS_PSRAM
    -mfix-esp32-psram-cache-issue
    
lib_deps = ${env:esp32dev.lib_deps}


[env:esp32-s3]
platform = espressif32
board = esp32-s3-devkitc-1
framework = arduino
monitor_speed = 115200
upload_speed = 921600

build_flags = 
    -DCORE_DEBUG_LEVEL=3
    -DARDUINO_USB_CDC_ON_BOOT=1
    
lib_deps = ${env:esp32dev.lib_deps}


[env:esp32-c3]
platform = espressif32
board = esp32-c3-devkitm-1
framework = arduino
monitor_speed = 115200
upload_speed = 921600

build_flags = 
    -DCORE_DEBUG_LEVEL=3
    -DARDUINO_USB_CDC_ON_BOOT=1
    
lib_deps = ${env:esp32dev.lib_deps}


; ===============================================
; Production build (optimized, no debug)
; ===============================================

[env:production]
platform = espressif32
board = esp32dev
framework = arduino
monitor_speed = 115200
upload_speed = 921600

build_flags = 
    -DCORE_DEBUG_LEVEL=0
    -O2
    -DNDEBUG
    
lib_deps = ${env:esp32dev.lib_deps}

; Smaller binary
build_unflags = 
    -DCORE_DEBUG_LEVEL=3


; ===============================================
; Debug build (with extra logging)
; ===============================================

[env:debug]
platform = espressif32
board = esp32dev
framework = arduino
monitor_speed = 115200
upload_speed = 460800

build_flags = 
    -DCORE_DEBUG_LEVEL=5
    -DDEBUG_SIGNALK
    -DDEBUG_ESP_PORT=Serial
    -DDEBUG_ESP_HTTP_SERVER
    -DDEBUG_ESP_WIFI
    -g
    -O0
    
lib_deps = ${env:esp32dev.lib_deps}

monitor_filters = 
    esp32_exception_decoder
    time
    log2file
    colorize


; ===============================================
; OTA Updates Configuration
; ===============================================

[env:ota]
platform = espressif32
board = esp32dev
framework = arduino
monitor_speed = 115200

; OTA settings
upload_protocol = espota
upload_port = signalk.local  ; or IP address
upload_flags = 
    --port=3232
    --auth=signalk123  ; Change this!

build_flags = 
    -DCORE_DEBUG_LEVEL=3
    
lib_deps = ${env:esp32dev.lib_deps}


; ===============================================
; Custom partition scheme (for more storage)
; ===============================================

[env:large_app]
platform = espressif32
board = esp32dev
framework = arduino
monitor_speed = 115200
upload_speed = 921600

; Custom partition table
; Create partitions_custom.csv in root:
; # Name,   Type, SubType, Offset,  Size, Flags
; nvs,      data, nvs,     0x9000,  0x5000,
; otadata,  data, ota,     0xe000,  0x2000,
; app0,     app,  ota_0,   0x10000, 0x1E0000,
; app1,     app,  ota_1,   0x1F0000,0x1E0000,
; spiffs,   data, spiffs,  0x3D0000,0x30000,

board_build.partitions = partitions_custom.csv

build_flags = 
    -DCORE_DEBUG_LEVEL=3
    
lib_deps = ${env:esp32dev.lib_deps}


; ===============================================
; Advanced Options
; ===============================================

[advanced]
; Uncomment and add to your env for advanced features

; PSRAM optimization
; build_flags = 
;     -DBOARD_HAS_PSRAM
;     -mfix-esp32-psram-cache-issue

; AsyncTCP tuning
; build_flags =
;     -DCONFIG_ASYNC_TCP_RUNNING_CORE=1
;     -DCONFIG_ASYNC_TCP_USE_WDT=0
;     -DCONFIG_ASYNC_TCP_QUEUE_SIZE=128
;     -DCONFIG_ASYNC_TCP_MAX_ACK_TIME=5000

; WiFiManager customization
; build_flags =
;     -DWM_MDNS
;     -DWM_DEBUG_LEVEL=DEBUG_VERBOSE

; JSON optimization
; build_flags =
;     -DARDUINOJSON_ENABLE_PROGMEM=1
;     -DARDUINOJSON_ENABLE_STD_STRING=1
;     -DARDUINOJSON_DECODE_UNICODE=1
